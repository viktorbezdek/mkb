# ADR-011: Visualization Layer — `mkb graph` and Export Formats

**Decision:** Add a `mkb graph` subcommand and structured export formats to enable
exploratory analysis beyond CLI text output. Output graph descriptions, not pixels —
let existing tools do the rendering.

**Context:**
The spec already references `mkb link --graph` and `mkb report decay` but doesn't
formalize how visualization works. A CLI-only interface limits exploratory analysis:
users can query documents but can't see temporal decay curves, supersession chains,
or link topology at a glance. Engineers and managers need visual tools to spot
patterns in knowledge graphs.

**Rationale:**
- MKB should produce *graph descriptions*, not implement a rendering engine
- DOT (Graphviz), Mermaid, and JSON are universal — every tool chain can consume them
- Keep the Rust binary lean: no GUI dependencies, no web server in core
- Mermaid renders natively in GitHub, Obsidian, Notion, and most AI editors
- For interactive exploration, a single-file HTML export with embedded JSON + D3.js
  covers the 80% case without adding runtime dependencies

**Architecture:**

```
mkb graph → GraphBuilder (Rust) → OutputFormat
                                    ├── DOT    → Graphviz / `dot -Tsvg`
                                    ├── Mermaid → GitHub / Obsidian / AI editors
                                    ├── JSON   → D3.js / custom tooling
                                    └── HTML   → Self-contained interactive viewer
```

**Commands:**

```bash
# Temporal knowledge graph centered on a document
mkb graph --center proj-alpha-001 --depth 2 --format mermaid

# Full type graph (all projects and their links)
mkb graph --type project --format dot | dot -Tsvg > projects.svg

# Supersession chain visualization
mkb graph --supersession proj-alpha --format mermaid

# Temporal decay heatmap (which docs are going stale?)
mkb graph --decay --type signal --format html > decay.html

# Link topology (who/what is connected to what?)
mkb graph --links --center person/jane-smith --depth 3 --format json
```

**Output Formats:**

| Format | Use Case | Rendering |
|--------|----------|-----------|
| `dot` | Publication-quality graphs | Graphviz CLI (`dot`, `neato`, `fdp`) |
| `mermaid` | Inline in docs, GitHub PRs, AI editors | Native Mermaid renderers |
| `json` | Programmatic consumption, custom UIs | Any JSON consumer |
| `html` | Interactive exploration | Self-contained, open in browser |

**Graph Types:**

1. **Link graph** — Document nodes, link edges, typed by relationship
2. **Supersession chain** — Linear chain of document versions over time
3. **Temporal decay** — Heatmap/treemap showing freshness across the vault
4. **Type topology** — Schema-level view of how types reference each other
5. **Contradiction map** — Conflicting facts with temporal ordering

**Implementation Notes:**
- `GraphBuilder` lives in `mkb-query` (it's a specialized query over the index)
- HTML export bundles a minimal D3.js force-directed graph as a single `<script>` tag
- Node metadata includes `observed_at`, `valid_until`, `confidence` for hover tooltips
- Edge metadata includes link `rel` type and `observed_at`
- Colors encode temporal freshness: green (fresh) → yellow (aging) → red (stale)

**Timeline:** Phase 5 (CLI Polish), after core query engine and link traversal are stable.

**Trade-offs:**
- DOT/Mermaid output is simple but limited for large graphs (>500 nodes)
- HTML export adds ~50KB of embedded JS — acceptable for a single-file viewer
- No real-time/live updating — graphs are snapshots, regenerate to refresh
- Deliberately no built-in web server — `mkb serve` (Phase 7/MCP) handles that path
