# ADR-012: Multi-User Extension Path

**Decision:** MKB v1.0 remains single-user/small-team. Document a clear extension
path to team-scale knowledge graphs using git-based collaboration, vault federation,
and conflict resolution leveraging temporal ordering.

**Context:**
The spec targets single-user and small-team use cases. But knowledge bases grow,
and teams need shared context. Rather than bolt on multi-user later (and break
assumptions), we document the extension path now so v1.0 decisions don't foreclose it.

**Rationale:**
- MKB is git-native by design (ADR-001) — git already solves multi-user file collaboration
- Temporal ordering (the core invariant) naturally resolves most "who wrote what when" conflicts
- Building multi-user into v1.0 would add authentication, permissions, locking, and
  real-time sync before the core is proven — premature complexity
- Teams already collaborate on markdown repos (wikis, docs sites) — MKB fits that model

**Extension Path — Three Tiers:**

### Tier 1: Shared Git Repository (works today)

```
Team members → clone same repo → push/pull → git handles merge
```

This works out of the box because:
- Vault files are markdown — git merges them well
- YAML frontmatter is structured — merge conflicts are rare and obvious
- `mkb index rebuild` regenerates indexes after pull (indexes are local cache)
- Each team member runs their own CLI against the shared vault

**Conflict resolution:** Git merge + temporal ordering. If two people edit the same
document, git merge resolves structurally. If they create contradicting facts,
MKB's temporal ordering (newer `observed_at` wins) resolves semantically.

**Limitations:** No real-time sync, no fine-grained access control, index rebuild
after every pull.

### Tier 2: Vault Federation (future, post-v1.0)

```
Personal vault ←→ Team vault ←→ Org vault
     (local)        (shared)      (read-only)
```

Each user maintains a personal vault. Team vaults aggregate shared knowledge.
Org vaults provide read-only reference data (company policies, org charts, etc.).

**Key mechanisms:**
- `mkb sync push` — publish selected documents from personal → team vault
- `mkb sync pull` — pull team knowledge into local vault
- `mkb sync subscribe --type signal` — auto-pull specific document types
- Sync is git-based (push/pull/merge) with optional filters
- Personal documents stay personal unless explicitly published

**Conflict resolution:** Same temporal ordering, but with provenance tracking.
When two sources disagree, confidence scoring (source reliability × temporal freshness)
determines which version surfaces in queries. Both versions are preserved.

### Tier 3: Real-Time Collaborative Vault (future, requires server)

```
Clients ←→ mkb-server ←→ Shared vault + shared index
```

For teams that need real-time shared queries and live signal propagation:
- `mkb-server` provides a shared query endpoint (likely via MCP, see ADR-009)
- Shared SQLite index (WAL mode for concurrent readers)
- Write coordination via lightweight locking or CRDT-based merge
- Event stream for "new signal detected" notifications

**This tier requires `mkb-server` and is explicitly out of scope for v1.0.**

**Design Constraints for v1.0 (to keep the path open):**

1. **Document identity is content-addressable** — `id` field is unique across vaults,
   enabling federation without ID collisions
2. **Provenance is always tracked** — `source` and `provenance` fields on every document
   identify where information came from, enabling multi-source merging
3. **Indexes are derived, not source of truth** — `mkb index rebuild` works on any
   vault state, so shared vaults don't need shared indexes
4. **Temporal ordering resolves conflicts** — no need for distributed consensus;
   newer `observed_at` wins, both versions preserved in git history
5. **No hardcoded paths** — vault location is configurable, enabling multiple vaults
   per machine (personal + team + org)

**What We Explicitly Do NOT Build in v1.0:**
- Authentication or authorization
- User/role management
- Real-time sync or notifications
- Shared server process
- Access control on individual documents

**Migration Path:**

```
v1.0: Single vault, single user           → Tier 1 for free (shared git repo)
v1.x: mkb sync commands                   → Tier 2 (vault federation)
v2.0: mkb-server + MCP (ADR-009)          → Tier 3 (real-time collaboration)
```

**Trade-offs:**
- Not building multi-user now means teams use git workflows (higher friction)
- Vault federation adds sync complexity — but defers it until core is proven
- Content-addressable IDs add a minor constraint now but enable federation later
- Teams larger than ~10 people will likely need Tier 2+ before MKB is useful org-wide
